name: Daily Future Tech Video Production

on:
  schedule:
    - cron: '0 13 * * *'  # ë§¤ì¼ 13:00 UTC (í•œêµ­ ì‹œê°„ 22:00)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  create-and-upload-video:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create temp directory
        run: mkdir -p temp

      - name: Set up Google credentials
        run: |
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > temp/google_credentials.json
          export GOOGLE_APPLICATION_CREDENTIALS="temp/google_credentials.json"

      - name: Generate script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python scripts/generate_script.py

      - name: Search Pexels videos
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: python scripts/search_videos.py

      - name: Create silent video
        run: python scripts/create_video.py

      - name: Generate audio (Google TTS)
        env:
          GOOGLE_APPLICATION_CREDENTIALS: temp/google_credentials.json
        run: python scripts/generate_audio.py

      - name: Merge audio and video
        run: python scripts/merge_audio_video.py

      - name: Generate thumbnail
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python scripts/generate_thumbnail.py

      - name: Add timestamp to description
        run: |
          if [ -f temp/script.txt ]; then
            echo -e "\n\nðŸ“ Generated on: $(date -u '+%Y-%m-%d %H:%M UTC')" >> temp/script.txt
          fi

      - name: Upload to YouTube
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          YOUTUBE_PLAYLIST_ID: ${{ secrets.YOUTUBE_PLAYLIST_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python scripts/upload_youtube.py

      - name: Extract shorts segments
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python scripts/extract_shorts.py

      - name: Create shorts videos
        run: python scripts/create_shorts.py

      - name: Upload shorts to YouTube
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          YOUTUBE_SHORTS_PLAYLIST_ID: ${{ secrets.YOUTUBE_SHORTS_PLAYLIST_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python scripts/upload_shorts.py

      - name: Save success metadata
        run: |
          echo "Video generation completed at $(date -u)" > temp/upload_success.txt
          if [ -f temp/youtube_url.txt ]; then
            cat temp/youtube_url.txt >> temp/upload_success.txt
          fi

      - name: Archive artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: video-artifacts
          path: |
            temp/final_video.mp4
            temp/thumbnail.jpg
            temp/script.txt
            temp/audio.mp3
            temp/short_*.mp4
            temp/upload_success.txt
            temp/youtube_url.txt
            temp/shorts_urls.txt
          retention-days: 90

      - name: Cleanup
        if: always()
        run: |
          rm -f temp/google_credentials.json
          echo "Cleanup completed"
